<head>
    <title>gitsup</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta property="og:title" content="gitsup" />
    <meta property="og:description" content="View a project's GitHub issues sorted by "up" votes!" />
    <meta property="og:url" content="https://gitsup.herokuapp.com" />
    <meta property="og:image" content="/logo.png" />

    <link rel="shortcut icon" href="/logo.png" />

    <link rel="stylesheet" type="text/css" href="/style.css">

    <script>

    Issues = new Mongo.Collection("issues")

    if(Meteor.isClient) {
        $(function() {
            var parser = document.createElement('a')
            parser.href = document.location.href
            var path = parser.pathname.split('/')

            var userName = path[1]
            var projectName = path[2]

            if(typeof userName == 'undefined' || typeof projectName == 'undefined') {
                return
            }

            var state = { userName:userName, projectName:projectName }

            Meteor.call('syncIssues', state, function(err, response) {
                if(err) {
                    Session.set('serverDataResponse', "Error:" + err.reason)
                    return
                }
            })

            var page = 1
            var alreadyAdded = []

            $('title').text(userName+'/'+projectName+' Â· gitsup')
            $('h2').html('<a href="https://github.com/'+userName+'/'+projectName+'">'+userName+'/'+projectName+'</a>')

            $('ol.list').empty()

            // A hack to know when it's ready to get data
            Meteor.subscribe('default_db_data', function(){

                var issues = Issues.find( {userName:userName, projectName:projectName}, {sort: {votes: 1}} ).fetch()

                if (typeof issues !== 'undefined') {
                    for (i = 0; i < issues.length; i++) {
                        alreadyAdded.push(issues[i].number)
                        var issue = extendIssue(issues[i])
                        $('ol.list').prepend(renderIssue(issue))
                    }
                }

                $.ajax('https://api.github.com/repos/'+userName+'/'+projectName+'/issues?state=all&sort=updated', {
                    beforeSend: function(xhr){xhr.setRequestHeader('Accept', 'application/vnd.github.squirrel-girl-preview');},
                    success: function(data) {
                        for (i = 0; i < data.length; i++) {
                          if(alreadyAdded.indexOf(data[i].number) == -1) {
                            var issue = extendIssue(data[i])

                            $('ol.list').append(renderIssue(issue))

                            Meteor.call("updateIssue", issue)

                          }
                        }

                        if(data.length >= 30) {
                            $('ol.list').after('<div class="showMore"><img src="/loading-bars.svg" alt="Loading.." class="loading-icon"/></div>')
                        }

                        // requests the next page of issues from github
                        function showMore(data){
                          page++
                          if($(".loading-icon")){$(".loading-icon").toggle()}
                          $.ajax({
                            url: 'https://api.github.com/repos/'+userName+'/'+projectName+'/issues?page='+page+'&state=all&sort=updated',
                            beforeSend: function(xhr){xhr.setRequestHeader('Accept', 'application/vnd.github.squirrel-girl-preview');},
                            statusCode: {
                              403: function (response) {
                                 alert("Looks like you are at the GitHub API rate limit. Don't worry, you can sign in to keep browsing!");
                              }
                            },
                            data: data,
                            success: function(data){
                              if(data.length == 0){
                                if(!$(".noMoreResults").length){
                                  $(".loading-icon").remove()
                                  $('ol.list').after('<div class="noMoreResults showMore">That\'s all the issues for '+ projectName +' :)</div>')
                                }
                              }
                              for (j = 0; j < data.length; j++) {
                                 if(alreadyAdded.indexOf(data[j].number) == -1) {
                                    var issue = extendIssue(data[j])
                                    $('ol.list').append(renderIssue(issue))
                                    Meteor.call("updateIssue", issue)
                                 }
                              }
                              if($(".loading-icon")){$(".loading-icon").toggle()}
                            },
                            failure: function(){console.log("failed to request more issues")},
                            dataType : "json",
                          });
                          return false
                        }

                        // infinite scroll feature
                        $(window).scroll(function() {
                           if($(window).scrollTop() + $(window).height() == $(document).height()) {
                             showMore()
                           }
                        });
                    }
                })
            })
        })

        function extendIssue(issue) {

            issue.userName = userName
            issue.projectName = projectName

            issue.votes = issue.reactions['+1']

            if(typeof issue.pull_request != 'undefined') {
                issue.type = 'pull'
            } else {
                issue.type = 'issue'
            }

            return issue
        }

        function renderIssue(issue) {
            return '<li class="'+issue.number+'">'+
                      '<h3>'+
                        '<a href="'+issue.html_url+'">'+issue.title+'<span> (#'+issue.number+')</span></a>'+
                      '</h3>'+
                      '<p>'+
                        '<span>'+
                          '<b>'+
                            issue.votes+' votes'+
                          '</b> '+
                          'by '+
                        '</span>'+
                        '<a href="'+issue.user.html_url+'">'+issue.user.login+'</a> '+
                        '<span>'+
                          moment(issue.created_at).fromNow()+' | '+
                        '</span> '+
                        '<a href="'+issue.html_url+'">'+issue.comments+' comments</a>'+
                      '</p>'+
                    '</li>'
        }
    }
    </script>
</head>
<body>
    <a href="https://github.com/coco/gitsup" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#1d1d1d; color:#ff6600; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner svg{z-index: 2000;}.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60438166-3', 'auto');
      ga('send', 'pageview');

    </script>
    <div class="container">
      <header>
          <h2>gitsup</h2>
      </header>
      <ol class="list">
          <h1>View a project's GitHub issues sorted by "up" votes!</h1>
          <h3>Go to <a href="https://gitsup.herokuapp.com/coco/gitsup">gitsup.herokuapp.com/user/project</a> to see an issue list sorted by "up" votes.</h3>
          <h4>Or save this handy bookmarklet for togling the url: <a class="bookmarklet" href="javascript:if(location.host.indexOf('gitsup.herokuapp.com') == -1){location.host='gitsup.herokuapp.com'}else{location.host='github.com'};">sup</a></h4>
      </ol>
    </div>
</body>
